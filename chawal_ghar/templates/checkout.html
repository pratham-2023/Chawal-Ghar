{% extends "layout.html" %}

{% block content %}
<h2>Checkout</h2>

<div class="checkout-container">
    <div class="order-summary">
        <h3>Order Summary</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td>{{ item.p_name }}</td>
                    <td>{{ item.quantity }} kg</td>
                    <td>₹{{ item.quantity * item.p_priceperunit }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2" style="text-align: right;"><strong>Total Amount:</strong></td>
                    <td><strong>₹{{ total_amount }}</strong></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="payment-section" style="margin-top: 30px;">
        <h3>Shipping Details</h3>
        <form action="{{ url_for('payment_success') }}" method="POST" id="payment-form">
            <div class="form-group">
                <label for="destination">Delivery Address:</label>
                <textarea name="destination" id="destination" required
                    placeholder="Enter your full address">{{ customer['c_address'] if customer and customer['c_address'] else '' }}</textarea>
            </div>

            <button id="rzp-button1" type="button" class="button"
                style="background-color: #3399cc; color: white; width: 100%; margin-top: 20px;">Pay with
                Razorpay</button>
        </form>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var options = {
        "key": "{{ key_id }}",
        "amount": "{{ payment.amount }}",
        "currency": "INR",
        "name": "Chawal Ghar",
        "description": "Purchase of Rice Products",
        "image": "https://example.com/your_logo",
        "order_id": "{{ payment.id }}",
        "handler": function (response) {
            // Ensure destination is filled
            var dest = document.getElementById('destination').value;
            if (!dest) {
                alert('Please enter a delivery address.');
                return;
            }

            // Submit the form to success route
            document.getElementById('payment-form').submit();

            // In a real implementation you would verify:
            // response.razorpay_payment_id
            // response.razorpay_order_id
            // response.razorpay_signature
        },
        "prefill": {
            "name": "{{ session['fullname'] }}",
            "email": "{{ customer['c_email'] if customer else 'customer@example.com' }}",
            "contact": "{{ customer['c_contact'] if customer else '9999999999' }}"
        },
        "notes": {
            "address": "Chawal Ghar Corporate Office"
        },
        "theme": {
            "color": "#3399cc"
        }
    };
    var rzp1 = new Razorpay(options);
    rzp1.on('payment.failed', function (response) {
        alert(response.error.description);
    });
    document.getElementById('rzp-button1').onclick = function (e) {
        var dest = document.getElementById('destination').value;
        if (!dest) {
            alert('Please enter a delivery address first.');
            return;
        }
        rzp1.open();
        e.preventDefault();
    }
</script>

<style>
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group textarea {
        width: 100%;
        padding: 8px;
    }
</style>
{% endblock %}